<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";

let confirmedData = [];
let userData = {};

// ===== JSONP CALL =====
function callAPI(params, cb) {
    const callbackName = 'jsonp_' + Date.now();
    window[callbackName] = (data) => {
        delete window[callbackName];
        document.body.removeChild(script);
        cb(data);
    };

    const script = document.createElement('script');
    const query = new URLSearchParams({
        ...params,
        callback: callbackName
    }).toString();

    script.src = `${API_URL}?${query}`;
    document.body.appendChild(script);
}

// ===== LOAD DEPARTMENTS =====
window.onload = () => {
    callAPI({ action: 'departments' }, (res) => {
        const dl = document.getElementById('depts');
        dl.innerHTML = "";

        // res คือ array ตรงจาก GAS
        res.forEach(d => {
            dl.innerHTML += `<option value="${d}">`;
        });
    });
};

// ===== REGISTER =====
function register() {
    userData = { 
        name: document.getElementById('reg-name').value.trim(), 
        dept: document.getElementById('reg-dept').value.trim(),
        email: document.getElementById('reg-email').value.trim()
    };

    if (!userData.name || !userData.dept || !userData.email) {
        Swal.fire('กรุณากรอกข้อมูลให้ครบ');
        return;
    }

    Swal.fire({ title:'กำลังส่งข้อมูล...', didOpen:()=>Swal.showLoading() });

    callAPI({ action:'login', username:userData.email, password:'-' }, (res) => {
        Swal.close();

        // mock ผ่านเพื่อเข้าใช้งาน
        document.getElementById('section-reg').classList.add('hidden');
        document.getElementById('section-survey').classList.remove('hidden');
        document.getElementById('user-dept-display').innerText =
            "หน่วยงาน: " + userData.dept;
    });
}

// ===== SEARCH ASSET (ยังไม่ผูก backend) =====
function searchAsset() {
    Swal.fire('ตัวอย่าง', 'ฟังก์ชันค้นหาครุภัณฑ์ยังไม่ได้ผูก GAS', 'info');
}

// ===== SUBMIT SURVEY =====
function submitSurvey() {
    Swal.fire('สำเร็จ', 'ตัวอย่างการส่งข้อมูล (ยังไม่ผูก GAS)', 'success')
        .then(showReport);
}

// ===== REPORT =====
function showReport() {
    document.querySelector('.no-print').classList.add('hidden');
    document.getElementById('section-report').classList.add('print-only');

    document.getElementById('report-dept').innerText = userData.dept;
    document.getElementById('report-user').innerText = userData.name;
    document.getElementById('report-date').innerText =
        new Date().toLocaleDateString('th-TH');

    document.getElementById('report-table-body').innerHTML =
        `<tr><td>-</td><td>ตัวอย่าง</td><td>ปกติ</td></tr>`;

    window.print();
}
</script>
