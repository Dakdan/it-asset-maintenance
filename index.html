<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบส่งข้อมูล และไฟล์งาน</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body{font-family:Prompt;background:#fff0f5;margin:0}
header{background:#ffb6c1;border-bottom:3px solid #000;padding:10px;display:flex;gap:15px}
header img{height:60px}
.card{border:2px solid #000;border-radius:14px;padding:20px;margin:20px;background:#fff}
input,button{width:100%;padding:8px;border-radius:8px;border:2px solid #000}
button{background:#ff69b4;color:#fff}
.hl{background:yellow}
</style>
</head>
<body>

<header>
<img src="https://img2.pic.in.th/pic/ink.png">
<div>
<b>โรงพยาบาลอุดรธานี</b><br>
กลุ่มงานเทคโนโลยีสารสนเทศ
</div>
</header>

<div class="card" id="login">
<input id="u" placeholder="Username">
<input id="p" type="password" placeholder="Password">
<button onclick="login()">เข้าสู่ระบบ</button>
</div>

<div class="card" id="main" style="display:none">
<b id="dept"></b>
<input id="k" placeholder="ใส่เลขท้ายรหัสครุภัณฑ์">
<button onclick="search()">ค้นหา</button>
<table id="tb"></table>
<button onclick="location.href='survey-annual.html'">สำรวจประจำปี</button>
<button onclick="location.href='dashboard.html'">Dashboard</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";
let dept="";
function jsonp(u,c){return new Promise(r=>{window[c]=d=>r(d);let s=document.createElement("script");s.src=u+"&callback="+c;document.body.appendChild(s);});}
async function login(){
  const r=await jsonp(`${API}?action=login&username=${u.value}&password=${p.value}`,"cbL");
  if(r.success){dept=r.dept;login.style.display="none";main.style.display="block";dept.innerText="หน่วยงาน: "+dept;}
  else Swal.fire("ผิดพลาด");
}
async function search(){
  const d=await jsonp(`${API}?action=search&key=${k.value}&dept=${dept}`,"cbS");
  tb.innerHTML=d.map(r=>`<tr>
    <td>${r[2]}</td>
    <td>${r[5].replace(k.value,`<span class=hl>${k.value}</span>`)}</td>
    <td><a href="detail.html?id=${r[2]}">Detail</a></td>
  </tr>`).join("");
}
</script>

</body>
</html>
