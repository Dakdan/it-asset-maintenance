<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบสำรวจครุภัณฑ์คอมพิวเตอร์</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Kanit', sans-serif; background:#fff0f3; }
    .card { border-radius:16px; }
    .hidden { display:none; }
  </style>
</head>
<body>

<div class="container mt-5">

  <div class="text-center mb-4">
    <img src="https://img2.pic.in.th/pic/ink.png" width="60"><br>
    <h4>ระบบสำรวจครุภัณฑ์คอมพิวเตอร์</h4>
    <p>โรงพยาบาลอุดรธานี</p>
  </div>

  <!-- REGISTER -->
  <div id="section-reg" class="card p-4 mx-auto" style="max-width:420px">
    <h5 class="text-center mb-3">ลงทะเบียนเข้าใช้งาน</h5>

    <input id="reg-email" class="form-control mb-2" placeholder="Email">
    <input id="reg-name" class="form-control mb-2" placeholder="ชื่อ - สกุล">
    <input list="depts" id="reg-dept" class="form-control mb-3" placeholder="หน่วยงาน">
    <datalist id="depts"></datalist>

    <button class="btn btn-primary w-100" onclick="register()">เข้าใช้งาน</button>
  </div>

  <!-- SURVEY -->
  <div id="section-survey" class="hidden mt-4">
    <div class="card p-4">
      <h5 id="user-dept"></h5>
      <p>แบบสำรวจครุภัณฑ์ (ตัวอย่าง)</p>
      <button class="btn btn-success" onclick="showReport()">ดูรายงาน</button>
    </div>
  </div>

  <!-- REPORT -->
  <div id="section-report" class="hidden mt-4">
    <div class="card p-4">
      <h5>รายงานการสำรวจ</h5>
      <p>หน่วยงาน: <span id="r-dept"></span></p>
      <p>ผู้รายงาน: <span id="r-name"></span></p>

      <table class="table table-bordered">
        <tr>
          <th>รหัส</th><th>รายการ</th><th>สถานะ</th>
        </tr>
        <tr>
          <td>COM-001</td><td>คอมพิวเตอร์</td><td>ปกติ</td>
        </tr>
      </table>

      <button class="btn btn-secondary" onclick="location.reload()">กลับหน้าแรก</button>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";

let confirmedData = [];
let userData = {};

/* ================= JSONP ================= */
function callAPI(params, cb) {
  const cbName = "cb_" + Date.now();
  params.callback = cbName;

  window[cbName] = (res) => {
    delete window[cbName];
    document.body.removeChild(script);
    cb(res);
  };

  const script = document.createElement("script");
  script.src = API_URL + "?" + new URLSearchParams(params).toString();
  document.body.appendChild(script);
}

/* ================= LOAD DEPARTMENT ================= */
window.onload = () => {
  callAPI({ action: "departments" }, (res) => {
    if (!res.success) return;
    const dl = document.getElementById("depts");
    dl.innerHTML = "";
    res.data.forEach(d => {
      dl.innerHTML += `<option value="${d.name}">`;
    });
  });
};

/* ================= REGISTER (mock login) ================= */
function register() {
  userData = {
    email: document.getElementById("reg-email").value.trim(),
    name: document.getElementById("reg-name").value.trim(),
    dept: document.getElementById("reg-dept").value.trim()
  };

  if (!userData.email || !userData.name || !userData.dept) {
    Swal.fire("กรุณากรอกข้อมูลให้ครบ");
    return;
  }

  document.getElementById("section-reg").classList.add("hidden");
  document.getElementById("section-survey").classList.remove("hidden");
  document.getElementById("user-dept-display").innerText =
    "หน่วยงาน: " + userData.dept;
}

/* ================= SEARCH ASSET ================= */
function searchAsset() {
  const q = document.getElementById("asset-query").value.trim();
  if (!q) return;

  Swal.fire({ title: "ค้นหา...", didOpen: () => Swal.showLoading() });

  callAPI({ action: "searchAssets", query: q }, (res) => {
    Swal.close();
    const box = document.getElementById("search-results");
    box.innerHTML = "";

    if (!res.success || res.data.length === 0) {
      box.innerHTML = `<div class="alert alert-warning">ไม่พบข้อมูล</div>`;
      return;
    }

    res.data.forEach(item => {
      box.innerHTML += `
        <div class="asset-card border-start border-4 border-primary">
          <small class="text-muted">AssetID: ${item.assetId}</small>
          <h6>${item.name}</h6>
          <p class="small">${item.detail}</p>
          <button class="btn btn-cute btn-sm"
            onclick='addAsset(${JSON.stringify(item)})'>
            เลือก
          </button>
        </div>
      `;
    });
  });
}

/* ================= ADD ASSET ================= */
function addAsset(item) {
  if (confirmedData.find(x => x.assetId === item.assetId)) {
    Swal.fire("เลือกไปแล้ว");
    return;
  }
  confirmedData.push(item);
  renderConfirmed();
}

/* ================= RENDER CONFIRM ================= */
function renderConfirmed() {
  const div = document.getElementById("survey-items");
  const wrap = document.getElementById("confirmed-list");
  wrap.classList.remove("hidden");

  div.innerHTML = confirmedData.map(x => `
    <div class="badge bg-white text-dark border p-2 m-1 cute-border">
      ${x.assetId} - ${x.name}
    </div>
  `).join("");
}

/* ================= SUBMIT SURVEY ================= */
function submitSurvey() {
  if (confirmedData.length === 0) {
    Swal.fire("ยังไม่ได้เลือกรายการ");
    return;
  }

  Swal.fire({ title: "กำลังบันทึก...", didOpen: () => Swal.showLoading() });

  let count = 0;
  confirmedData.forEach(item => {
    callAPI({
      action: "saveSurvey",
      data: JSON.stringify({
        assetId: item.assetId,
        assetGroup: item.assetGroup,
        name: item.name,
        detail: item.detail,
        deptName: userData.dept,
        maStatus: item.maStatus,
        coStatus: item.coStatus
      })
    }, () => {
      count++;
      if (count === confirmedData.length) {
        Swal.fire("สำเร็จ", "บันทึกข้อมูลเรียบร้อย", "success")
          .then(showReport);
      }
    });
  });
}

/* ================= REPORT ================= */
function showReport() {
  document.querySelector(".no-print").classList.add("hidden");
  document.getElementById("section-report").classList.add("print-only");

  document.getElementById("report-dept").innerText = userData.dept;
  document.getElementById("report-user").innerText = userData.name;
  document.getElementById("report-date").innerText =
    new Date().toLocaleDateString("th-TH");

  document.getElementById("report-table-body").innerHTML =
    confirmedData.map(x => `
      <tr>
        <td>${x.assetId}</td>
        <td>${x.name}</td>
        <td>ปกติ</td>
      </tr>
    `).join("");

  window.print();
}
</script>

</body>
</html>
