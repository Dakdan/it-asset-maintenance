<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบส่งข้อมูล และไฟล์งาน</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{font-family:Prompt,sans-serif;background:#fff0f5;margin:0}
header{background:#ffb6c1;border-bottom:3px solid #000;padding:10px;display:flex;gap:15px}
header img{height:60px}
.card{border:2px solid #000;border-radius:16px;padding:20px;margin:20px;background:#fff}
input,button{padding:8px;border-radius:8px;border:2px solid #000;width:100%}
button{background:#ff69b4;color:#fff;margin-top:10px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #000;padding:6px}
.hl{background:yellow}
.dropdown{border:2px solid #000;position:absolute;background:#fff;width:100%;z-index:10}
.dropdown div{padding:6px;cursor:pointer}
.dropdown div:hover{background:#ffb6c1}
.hidden{display:none}
</style>
</head>

<body>

<header>
<img src="https://img2.pic.in.th/pic/ink.png">
<div>
<b>โรงพยาบาลอุดรธานี</b><br>
กลุ่มงาน: เทคโนโลยีสารสนเทศคอมพิวเตอร์<br>
โทร 1125,1126,1485
</div>
</header>

<!-- LOGIN -->
<div class="card" id="loginCard">
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">เข้าสู่ระบบ</button>
</div>

<!-- SURVEY -->
<div class="card hidden" id="surveyCard">
<b id="deptName"></b>
<input id="keyword" placeholder="ใส่เลขท้ายรหัสครุภัณฑ์">
<button onclick="search()">ค้นหา</button>

<table id="result"></table>

<h4>รายการที่เลือก</h4>
<ul id="picked"></ul>

<button onclick="submit()">ส่งแบบสำรวจ</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";
let dept="", selected=[];

function jsonp(url,cb){
  return new Promise(r=>{
    window[cb]=d=>r(d);
    const s=document.createElement("script");
    s.src=url+"&callback="+cb;
    document.body.appendChild(s);
  });
}

/* LOGIN */
async function login(){
  const r=await jsonp(`${API}?action=login&username=${username.value}&password=${password.value}`,"cbLogin");
  if(r.success){
    dept=r.dept;
    deptName.innerText="หน่วยงาน: "+dept;
    loginCard.classList.add("hidden");
    surveyCard.classList.remove("hidden");
  }else Swal.fire("ผิดพลาด");
}

/* SEARCH */
async function search(){
  Swal.fire({title:"ค้นหา...",didOpen:()=>Swal.showLoading()});
  const data=await jsonp(`${API}?action=search&key=${keyword.value}&dept=${dept}`,"cbSearch");
  Swal.close();

  result.innerHTML="<tr><th>รหัส</th><th>ชื่อ</th><th></th></tr>"+
    data.map(r=>{
      const name=r[5].replace(keyword.value,`<span class=hl>${keyword.value}</span>`);
      return `<tr>
        <td>${r[2]}</td>
        <td>${name}</td>
        <td><button onclick='add(${JSON.stringify(r)})'>ใช้งานอยู่</button></td>
      </tr>`;
    }).join("");
}

function add(r){
  selected.push(r);
  picked.innerHTML=selected.map(x=>`<li>${x[2]} - ${x[5]}</li>`).join("");
}

/* SAVE */
async function submit(){
  await jsonp(`${API}?action=save&dept=${dept}&data=${encodeURIComponent(JSON.stringify(selected))}`,"cbSave");
  Swal.fire("บันทึกแล้ว");
}
</script>

</body>
</html>
