<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สำรวจครุภัณฑ์ประจำปี</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{font-family:Prompt;background:#fff0f5;margin:0}
.card{border:2px solid #000;border-radius:14px;padding:20px;margin:20px;background:#fff}
button{background:#ff69b4;color:#fff;border:none;padding:8px 14px;border-radius:8px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #000;padding:6px}
.hl{background:yellow}
</style>
</head>

<body>

<div class="card">
<h3>สำรวจ / ยืนยัน ครุภัณฑ์ ประจำปีงบ 2568</h3>

<input id="key" placeholder="ใส่เลขท้ายรหัสครุภัณฑ์">
<button onclick="search()">ค้นหา</button>

<table id="result"></table>

<h4>รายการที่เลือก</h4>
<ul id="list"></ul>

<button onclick="save()">บันทึกข้อมูล</button>
<button onclick="window.print()">พิมพ์ A4</button>
<button onclick="location.href='index.html'">กลับหน้าหลัก</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwj8TX_Lwv_oRLd3CtFL7ORBSu4CyweKfdoxF5vi-7UBqPeml6EBNmCCLDJ7qmsKqjD/exec";
let picked=[];

function jsonp(url,cb){
  return new Promise(r=>{
    window[cb]=d=>r(d);
    let s=document.createElement("script");
    s.src=url+"&callback="+cb;
    document.body.appendChild(s);
  });
}

async function search(){
  const data=await jsonp(`${API}?action=searchAnnual&key=${key.value}`,"cbA");
  result.innerHTML="<tr><th>รหัส</th><th>ชื่อ</th><th></th></tr>"+
    data.map(r=>{
      return `<tr>
        <td>${r[2]}</td>
        <td>${r[5].replace(key.value,`<span class=hl>${key.value}</span>`)}</td>
        <td><button onclick='add(${JSON.stringify(r)})'>เพิ่ม</button></td>
      </tr>`;
    }).join("");
}

function add(r){
  picked.push(r);
  list.innerHTML=picked.map(x=>`<li>${x[2]} - ${x[5]}</li>`).join("");
}

async function save(){
  await jsonp(`${API}?action=saveAnnual&data=${encodeURIComponent(JSON.stringify(picked))}`,"cbSave");
  Swal.fire("บันทึกสำเร็จ");
}
</script>

</body>
</html>
<link rel="manifest" href="manifest.json">
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

